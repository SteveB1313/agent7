{% extends "template.html" %}

  {% block head %}
    {{ super() }}
    {% import "macros.html" as macro %}
    {{ macro.filehelper(datatables=True,chartjs=True) }}
    <link href="{{url_for('static',filename='assets/css/table.css')}}" rel="stylesheet" />
<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
  {% endblock %}

  {% block body %}
        <div class="row">
          <div class="col-lg-3">
            <form class="form-inline" style="margin-bottom:10px;" method="GET" action="{{url_for('agent_ui.service')}}">
              <input type="hidden" type="text" class="form-control" name="priv_view" value="true">
              
              <button type="submit" class="btn btn-primary btn-simple btn-xs">Privileged View</button>
<!--              <input class="toggleItem" id="toggle-event" type="checkbox" "checked" data-toggle="toggle" data-on="Priv. View On" data-off="Priv. View Off" data-onstyle="success" data-offstyle="danger" data-size="small" data-width="150"> -->
            </form>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-3">
            <div class="card card-chart">
              <div class="card-header">
                <h1 class="card-category">Service status</h1>
                <h3 class="card-title"><i class="tim-icons icon-bulb-63 text-success"></i>Service Status</h3>
              </div>
              <div class="card-body">
                <div class="chart-area">
                  <canvas id="chart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-9">
            <div class="card card-chart">
              <div class="card-header">
                <h1 class="card-category">Top processes</h1>
                <h3 class="card-title"><i class="tim-icons icon-bulb-63 text-success"></i>Top Processes</h3>
              </div>
              <div class="card-body">
                <div class="chart-area">
                  <canvas id="chart2"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-8">
            <div class="card card-chart">
              <div class="card-header">
                <h1 class="card-category">Top Services</h1>
                <h3 class="card-title"><i class="tim-icons icon-bulb-63 text-success"></i>Top Services</h3>
              </div>
              <div class="card-body">
                <div class="chart-area">
                  <canvas id="chart3"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card card-chart">
              <div class="card-header">
                <h1 class="card-category">Services Running under user</h1>
                <h3 class="card-title"><i class="tim-icons icon-bulb-63 text-success"></i>Accounts Running Services</h3>
              </div>
              <div class="card-body">
                <div class="chart-area">
                  <canvas id="chart4"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-12">
            <div class="card card-chart">
              <div class="card-header">
                <h3 class="card-title"><i class="tim-icons icon-book-bookmark text-success"></i> Top Processes by command line</h3>
                <h5 class="card-title" style="display:inline-block;"></i> Grouped Processes by Command Path</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table id="example4" class="table table-striped table-bordered"  style="width:100%">
                    <thead><tr></tr></thead>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-12 col-md-12">
            <div class="card ">
              <div class="card-header">
                <h3 class="card-title"><i class="tim-icons icon-book-bookmark text-success"></i> Processes</h3>
                <h5 class="card-title" style="display:inline-block;"></i> All process data</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table id="example3" class="table table-striped table-bordered"  style="width:100%">
                    <thead><tr></tr></thead>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-12">
            <div class="card card-chart">
              <div class="card-header">
                <h1 class="card-category">Top services grouped by path name</h1>
                <h3 class="card-title"><i class="tim-icons icon-bulb-63 text-success"></i>Services Grouped by Command Path</h3>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table id="example2" class="table table-striped table-bordered"  style="width:100%">
                    <thead><tr></tr></thead>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-12 col-md-12">
            <div class="card ">
              <div class="card-header">
                <h3 class="card-title"><i class="tim-icons icon-book-bookmark text-success"></i> Services (SCM)</h3>
                <h5 class="card-title" style="display:inline-block;"></i> Services in Service Control Manager</h5>
                <button type="button" style="float:right;display:inline-block;" rel="tooltip" class="btn btn-primary btn-link btn-sm btn-icon " data-original-title="Refresh" title="" data-toggle="modal" data-target="#helpModal">
                            <i class="tim-icons icon-bulb-63"></i>
                </button>
              </div>

              <div class="card-body">
                <div class="table-responsive">
                  <table id="example" class="table table-striped table-bordered"  style="width:100%">
                    <thead><tr></tr></thead>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
  {%endblock%}

  {% block extra_js%}
  <script>
    $(document).ready(function (){
        $.noConflict();

        var url = new URL(window.location.href);
        var as_priv = url.searchParams.get("priv_view") || "false";

        var table4 = cjs_init(
            selector="chart",
            url="/api/agent/data/agentservice?as_chartjs=true&groupby=status,count&filter=is_priv,eq,"+as_priv,
            type="doughnut", // type of graph (line,pie,bar,doughnut,polarArea)
            graph_label="Testing", // header of graph
        );
        var table2 = cjs_init(
            selector="chart2",
            url="/api/agent/data/agentprocess?as_chartjs=true&groupby=image,count&filter=is_priv,eq,"+as_priv,
            type="horizontalBar", // type of graph (line,pie,bar,doughnut,polarArea)
            graph_label="Process Image", // header of graph
        );
        var table3 = cjs_init(
            selector="chart3",
            url="/api/agent/data/agentservice?as_chartjs=true&groupby=image,count&filter=status,eq,Running;is_priv,eq,"+as_priv,
            type="horizontalBar", // type of graph (line,pie,bar,doughnut,polarArea)
            graph_label="Service Image", // header of graph
        );
        var table2 = cjs_init(
            selector="chart4",
            url="/api/agent/data/agentservice?as_chartjs=true&groupby=username,count&filter=username,ne,None;is_priv,eq,"+as_priv,
            type="bar", // type of graph (line,pie,bar,doughnut,polarArea)
            graph_label="User", // header of graph
        );
        var table = dt_init(
            selector="#example4", // table id selector
            url = "/api/agent/data/agentprocess?as_datatables=true&groupby=command,count;image,group&limit=100&filter=is_priv,eq,"+as_priv, // data url source
            dt_ajax=0, // 1=render columns manually (requires render_cols="col1,col2,col3", 0=render columns dynamically
            render_cols=0, // columns rendered (only used when dt_ajax=1)
            edit=1, // add a column with a edit icon
            link_url="/ui/process/image", // link of the icon if the edit attribute is set
            auto_id=1, // reads id from data and appends it to the link url
            index=2, // index from array to attach to the link
            colname="View" // column name
        );
        var table = dt_init(
            selector="#example3", // table id selector
            url = "/api/agent/data/agentprocess?as_datatables=true&limit=500&visible=image,username,pid,command,host_name&filter=is_priv,eq,"+as_priv, // data url source
            dt_ajax=0, // 1=render columns manually (requires render_cols="col1,col2,col3", 0=render columns dynamically
            render_cols=0, // columns rendered (only used when dt_ajax=1)
            edit=0, // add a column with a edit icon
        );
        var table = dt_init(
            selector="#example2", // table id selector
            url="/api/agent/data/agentservice?as_datatables=true&groupby=image,count;command,group&limit=100&filter=is_priv,eq,"+as_priv,
            dt_ajax=0, // 1=render columns manually (requires render_cols="col1,col2,col3", 0=render columns dynamically
            render_cols=0, // columns rendered (only used when dt_ajax=1)
            edit=0, // add a column with a edit icon
        );
        // draw datatable
        var table = dt_init(
            selector="#example", // table id selector
            url = "/api/agent/data/agentservice?as_datatables=true&visible=image,username,display_name,start_type,command,description,host_name&filter=is_priv,eq,"+as_priv, // data url source
            dt_ajax=0, // 1=render columns manually (requires render_cols="col1,col2,col3", 0=render columns dynamically
            render_cols=0, // columns rendered (only used when dt_ajax=1)
            edit=0, // add a column with a edit icon
        );

    });
//haaaaaa
    $(function() {
      // add parameter and reload page for privileged view
      $('#toggle-event').change(function() {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('priv_view', $(this).prop('checked'));
        window.location.search = urlParams;
      })

      $('.toggleItem').change(function (event) {
        var $this = $(this);
        var state = $this.prop('checked');
        console.log("here")
        //on error
        $this.prop('checked', !state).bootstrapToggle('destroy').bootstrapToggle();
      });

      // change status of toggle
      if ($('#toggle-event').prop('checked')) {
        console.log('checked')
//        $('#toggle-event').bootstrapToggle('on')
      } else {
        console.log('not checked')
        //$('#toggle-event').bootstrapToggle('off')
      }

    })
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('priv_view')) {
      console.log("here4")
      $('.toggleItem').prop('checked');
    } else {
      console.log("here5")
      $('.toggleItem').prop('');
    }
   


  </script>
  {%endblock%}

